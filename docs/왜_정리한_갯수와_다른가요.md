# 왜 정리한 갯수와 다른가요?

사용자가 정리한 데이터(분류 결과)가 실제 내보내기 결과와 갯수가 다른 이유는 **'분류 규칙'과 '내보내기 템플릿'의 매핑 관계** 때문입니다.

규칙 파일(`rules/amc.yaml`)에 정의된 **여러 카테고리가 하나의 내보내기 코드로 통합(Merge)**되거나, 반대로 **특정 카테고리가 내보내기 대상에서 제외**될 수 있습니다.

## 1. 분류와 내보내기 구조
데이터는 아래와 같은 3단계를 거쳐 최종 엑셀 파일로 변환됩니다.

1. **분류 (Classification)**: 데이터를 분석하여 `category_id`(예: `ct_chest`)를 부여합니다.
2. **이름 매핑 (Name Mapping)**: `category_id`에 해당하는 **한글 이름**(예: "흉부")을 찾습니다.
3. **코드 변환 (Export Mapping)**: 한글 이름을 기준으로 **내보내기 코드**(예: `2`)로 변환합니다.

이 과정에서 **"다대일(N:1)" 매핑**이 발생하면 갯수가 합쳐져 보일 수 있습니다.

## 2. 주요 매핑 예시 (amc.yaml 기준)

아래 표는 `rules/amc.yaml` 파일의 `template_column_mapping`을 기준으로 작성된 매핑 예시입니다.

| 분류 카테고리 (ID) | 한글 이름 (Category Name) | 내보내기 구분 (Modality) | 내보내기 세부전공 (Specialty) | 결과 코드 | 비고 |
|:---:|:---:|:---:|:---:|:---:|:---|
| `xray_neu` | 신경두경부 | 일반촬영 | 신경두경부 | **1 - 1** | 1:1 매핑 |
| `xray_cht` | 흉부 | 일반촬영 | 흉부 | **1 - 2** | 1:1 매핑 |
| `ct_neu` | 신경두경부 | CT | 신경두경부 | **2 - 1** | 1:1 매핑 |
| `ct_chest` | 흉부 | CT | 흉부 | **2 - 2** | 1:1 매핑 |
| `mri_neu` | 신경두경부 | MRI | 신경두경부 | **3 - 1** | 1:1 매핑 |
| `fluoroscopy_abd` | 복부 | 투시 | 복부 | **5 - 3** | 1:1 매핑 |
| **`fluoroscopy_ped`** | **소아** | **투시** | **소아** | **5 - 12** | **통합** |
| `intervention_neu` | 뇌혈관조영술... | 시술 | 뇌혈관조영술... | **8 - 1** | 긴 이름 매핑 |
| `intervention_thyroid` | 초음파 유도하... | 시술 | 초음파 유도하... | **8 - 2** | 긴 이름 매핑 |

### 통합(Merge)이 발생하는 경우
만약 사용자가 `ct_chest_lowdose`(저선량 흉부 CT)라는 새로운 카테고리를 만들고, 이름을 "흉부"로 설정했다면:
- `ct_chest` -> "흉부" -> **2 - 2**
- `ct_chest_lowdose` -> "흉부" -> **2 - 2**

이 경우, 두 카테고리의 데이터는 내보내기 시 **모두 '흉부(2-2)'로 합쳐져서 출력**됩니다. (갯수는 합산됨)

### 제외(Filter)가 발생하는 경우
내보내기 템플릿(`template_column_mapping`)에 정의되지 않은 카테고리는 **'기타(999)'로 분류되거나 제외**될 수 있습니다.
- 예: `new_category` -> "새로운검사" -> 매핑 없음 -> **누락 또는 에러**

## 3. 확인 방법
1. `rules/amc.yaml` 파일을 엽니다.
2. `categories` 섹션에서 `category_id`와 `name`을 확인합니다.
3. `export_as_sheet` > `template_column_mapping` 섹션에서 해당 `name`이 어떤 `value`(코드)로 매핑되는지 확인합니다.
4. 여러 카테고리가 같은 `value`를 가리키고 있다면, 해당 데이터들은 합쳐져서 집계됩니다.

## 4. 데이터 집계 (Aggregation)
일부 병원 업로드 양식은 개별 환자 데이터를 요구하는 대신, **"Modality 별 총 건수"** 만을 요구할 수 있습니다.
- 이 경우, 엑셀 파일에는 **단 1줄**(예: "CT 흉부: 50건")만 생성될 수 있습니다.
- 원본 데이터는 50개지만, 파일 행 수는 1개가 되므로 갯수 차이가 발생한 것처럼 보일 수 있습니다.

---
**요약**: "정리한 갯수"는 내부 분류 기준(Category ID)의 합계이며, "내보낸 갯수"는 매핑 규칙(Export Mapping)에 따라 통합되거나 필터링된 결과의 합계입니다.

# 데이터 내보내기 가이드

## 개요

Logbook Manager의 데이터 내보내기 기능은 로그북 데이터를 다양한 형식으로 내보낼 수 있도록 설계되었습니다. 이 기능을 통해 사용자는 데이터를 Excel 파일(.xlsx) 또는 CSV 파일(.csv)로 내보내어 외부 분석 도구에서 활용할 수 있습니다.

## 주요 기능

- **다양한 형식 지원**: Excel (.xlsx) 및 CSV (.csv) 형식 지원
- **컬럼 매핑**: 데이터 필드를 원하는 컬럼명으로 매핑
- **템플릿 시스템**: 미리 정의된 템플릿을 통한 빠른 내보내기
- **데이터 변환**: 나이를 소아/성인으로 변환하는 등 데이터 가공 기능

## 설정 구조

### 1. ExportSheetConfig 속성

| 속성             | 타입   | 필수/옵션 | 기본값 | 설명                               |
| ---------------- | ------ | --------- | ------ | ---------------------------------- |
| `default_format` | string | **필수**  | -      | 기본 내보내기 형식 (`csv`, `xlsx`) |
| `encoding`       | string | **필수**  | -      | 파일 인코딩 (예: `utf-8`)          |
| `filename`       | object | **필수**  | -      | 파일명 설정                        |
| `templates`      | array  | **필수**  | -      | 내보내기 템플릿 배열               |

#### 1.1 Filename 설정

| 속성          | 타입   | 필수/옵션 | 기본값 | 설명                                             |
| ------------- | ------ | --------- | ------ | ------------------------------------------------ |
| `pattern`     | string | **필수**  | -      | 파일명 패턴 (예: `logbook_export_{date}_{time}`) |
| `date_format` | string | **필수**  | -      | 날짜 형식 (예: `YYYY-MM-DD`)                     |
| `time_format` | string | **필수**  | -      | 시간 형식 (예: `HH-mm-ss`)                       |

### 2. ExportTemplate 속성

| 속성           | 타입   | 필수/옵션 | 기본값 | 설명                      |
| -------------- | ------ | --------- | ------ | ------------------------- |
| `name`         | string | **필수**  | -      | 템플릿 이름 (고유 식별자) |
| `description`  | string | **필수**  | -      | 템플릿 설명               |
| `column_order` | array  | **필수**  | -      | 컬럼 순서 배열            |
| `columns`      | array  | **필수**  | -      | 컬럼 정의 배열            |

#### 2.1 기본 컬럼 순서 정의

```yaml
column_order:
  - 'serial_number' # 일련번호
  - 'modality' # 검사종류
  - 'specialty' # 세부전공
  - 'age_group' # 소아/성인
  - 'sex' # 환자성별
  - 'study_date' # 검사일(년-월-일)
  - 'reading_date' # 판독일(년-월-일)
  - 'exam_name' # 검사명
```

#### 컬럼 정의

각 컬럼은 다음과 같은 속성을 가집니다:

```yaml
columns:
  - serial_number:
      name: '일련번호' # 표시될 컬럼명
      type: 'number' # 데이터 타입 (string, number, date, boolean)
      value:
        auto_increment:
          start_value: 1
          increment: 1
      width: 80 # 컬럼 너비 (픽셀)

  - modality:
      name: '검사종류' # 표시될 컬럼명
      type: 'string' # 데이터 타입
      value:
        from_metadata:
          key: examination_type_name
      width: 120 # 컬럼 너비 (픽셀)
```

### 3. 컬럼 속성 상세 설명

#### 3.1 기본 속성

| 속성          | 타입   | 필수/옵션 | 기본값       | 설명                                                |
| ------------- | ------ | --------- | ------------ | --------------------------------------------------- |
| `name`        | string | **필수**  | -            | 엑셀/CSV에서 표시될 컬럼 헤더명                     |
| `type`        | string | **필수**  | -            | 데이터 타입 (`string`, `number`, `date`, `boolean`) |
| `width`       | number | 옵션      | -            | 컬럼 너비 (픽셀 단위), csv형식에서는 무시됨.           |
| `description` | string | 옵션      | -            | 컬럼에 대한 설명                                    |
| `format`      | string | 옵션      | `YYYY-MM-DD` | type이 `date`인 경우 날짜 형식                      |

#### 3.2 Value 소스 속성

> **중요**: `value` 속성은 아래 Value 타입 중 **정확히 하나**를 선택해야 합니다.

##### 3.2.1 auto_increment

| 속성          | 타입   | 필수/옵션 | 기본값 | 설명              |
| ------------- | ------ | --------- | ------ | ----------------- |
| `start_value` | number | 옵션      | `1`    | 자동 증가 시작 값 |
| `increment`   | number | 옵션      | `1`    | 증가 단위         |

##### 3.2.2 from_metadata

| 속성  | 타입   | 필수/옵션 | 기본값 | 설명            |
| ----- | ------ | --------- | ------ | --------------- |
| `key` | string | **필수**  | -      | 메타데이터 키명 |

##### 3.2.3 from_field

| 속성    | 타입   | 필수/옵션 | 기본값 | 설명          |
| ------- | ------ | --------- | ------ | ------------- |
| `field` | string | **필수**  | -      | 데이터 필드명 |

##### 3.2.4 static

| 속성    | 타입          | 필수/옵션 | 기본값 | 설명      |
| ------- | ------------- | --------- | ------ | --------- |
| `value` | string/number | **필수**  | -      | 고정할 값 |

##### 3.2.5 transform

| 속성           | 타입   | 필수/옵션 | 기본값 | 설명                   |
| -------------- | ------ | --------- | ------ | ---------------------- |
| `source_field` | string | **필수**  | -      | 변환할 소스 필드       |
| `default_value` | string/number | 옵션     | -      | 소스 값이 비었을 때 사용할 기본값 |
| `operations`   | array  | **필수**  | -      | 순차적으로 적용할 변환 연산 목록 |

`transform`은 JavaScript 함수를 직접 작성하는 방식이 아니라, **미리 정의된 연산자들을 순차적으로 적용하는 DSL**로 동작합니다. 각 연산자는 `operations` 배열에 정의한 순서대로 실행됩니다.

###### Transform 연산자 사용법

```yaml
value:
  transform:
    source_field: age
    operations:
      - type: case
        cases:
          - when:
              lt: 17
            value: '소아'
          - when:
              gte: 65
            value: '고령'
        default: '성인'
      - type: suffix
        value: ' 환자'
```

지원되는 연산자는 다음과 같습니다.

| 유형                                    | 설명                                                                                                                                                                    |
| --------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `uppercase`, `lowercase`, `trim`        | 문자열을 대/소문자로 변환하거나 앞뒤 공백 제거                                                                                                                          |
| `prefix`, `suffix`                      | 문자열 앞/뒤에 값을 붙입니다.                                                                                                                                           |
| `replace`                               | 단순 문자열 치환 (`search` 전체를 `replace`로 교체).                                                                                                                    |
| `default`                               | 값이 비어 있을 때 지정된 기본값을 사용합니다.                                                                                                                           |
| `add`, `subtract`, `multiply`, `divide` | 숫자 연산. `divide`는 `precision` 옵션으로 소수점 반올림을 지정할 수 있습니다.                                                                                          |
| `round`, `toFixed`                      | 반올림 또는 고정 소수점 문자열 반환.                                                                                                                                    |
| `map`                                   | 딕셔너리 매핑. 일치 항목이 없으면 `fallback`을 사용할 수 있습니다.                                                                                                      |
| `case`                                  | 조건에 따라 값을 선택합니다. `when` 조건은 `equals`, `in`, `lt`, `lte`, `gt`, `gte`, `contains`, `regex`를 조합할 수 있으며, 일치 항목이 없으면 `default`가 사용됩니다. |

소스 필드 값이 비어 있을 때 기본값을 지정하려면 `default_value`를 사용할 수 있습니다.

```yaml
value:
  transform:
    source_field: modality
    default_value: 'UNKNOWN'
    operations:
      - type: uppercase
```

##### 3.2.6 conditional

| 속성         | 타입   | 필수/옵션 | 기본값 | 설명        |
| ------------ | ------ | --------- | ------ | ----------- |
| `conditions` | array  | **필수**  | -      | 조건 배열   |
| `default`    | object | 옵션      | -      | 기본값 소스 |

##### 3.2.7 fallback_chain

| 속성 | 타입  | 필수/옵션 | 기본값 | 설명                                          |
| ---- | ----- | --------- | ------ | --------------------------------------------- |
| -    | array | **필수**  | -      | 순차적 fallback 체인 (ColumnValueSource 배열) |

#### 3.3 Conditional 조건 속성

| 속성             | 타입          | 필수/옵션 | 설명                                                       |
| ---------------- | ------------- | --------- | ---------------------------------------------------------- |
| `field`          | string        | **필수**  | 메타데이터 키 또는 데이터 필드                             |
| `operator`       | string        | **필수**  | 연산자 (아래 표 참조)                                      |
| `value`          | string/number | 옵션      | 비교할 값 (operator가 `is_null`, `not_null`인 경우 불필요) |
| `case_sensitive` | boolean       | 옵션      |  대소문자 구분 여부, 생략될 경우 기본값 `false` |

#### 3.4 지원하는 연산자

| 연산자         | 설명          | value 필요 | 예시     |
| -------------- | ------------- | ---------- | -------- |
| `equals`       | 정확히 일치   | **필수**   | `"소아"` |
| `not_equals`   | 일치하지 않음 | **필수**   | `"성인"` |
| `contains`     | 포함됨        | **필수**   | `"CT"`   |
| `not_contains` | 포함되지 않음 | **필수**   | `"MRI"`  |
| `is_null`      | null 값       | 불필요     | -        |
| `not_null`     | null이 아님   | 불필요     | -        |

### 4. 유연한 값 소스 설정

#### 4.1 조건부 값 선택

특정 조건에 따라 다른 소스에서 값을 가져올 수 있습니다:

```yaml
- specialty:
    name: '세부전공'
    type: 'string'
    width: 150
    value:
      conditional:
        conditions:
          - condition:
              field: 'specialty_name'
              operator: 'equals'
              value: '소아'
            value_source:
              from_metadata:
                key: 'remarks_name'
          - condition:
              field: 'specialty_name'
              operator: 'not_equals'
              value: '소아'
            value_source:
              from_metadata:
                key: 'specialty_name'
        default:
          from_metadata:
            key: 'specialty_name'
```

#### 4.2 Fallback 체인

여러 소스를 순차적으로 시도하여 첫 번째로 값이 있는 것을 사용합니다:

```yaml
- exam_name:
    name: '검사명'
    type: 'string'
    width: 200
    value:
      fallback_chain:
        - from_field:
            field: 'exam_name'
        - from_metadata:
            key: 'exam_name'
        - static:
            value: '검사명 없음'
```

#### 4.3 데이터 변환 기능

특정 컬럼에 대해 데이터를 변환할 수 있습니다. `source_field`에서 가져온 값을 기준으로 순차적인 연산을 적용합니다:

```yaml
- age_group:
    name: '소아/성인'
    type: 'string'
    width: 100
    description: '소아(17세 미만) 또는 성인 구분'
    value:
      transform:
        source_field: 'age'
        default_value: ''
        operations:
          - type: case
            cases:
              - when:
                  lt: 17
                value: '소아'
            default: '성인'
```

### 5. 자동 증가 번호 생성

일련번호와 같이 순차적으로 증가하는 번호가 필요한 경우:

```yaml
- serial_number:
    name: '일련번호'
    type: 'number'
    width: 80
    description: '순차적으로 증가하는 일련번호 (자동 생성)'
    value:
      auto_increment:
        start_value: 1 # 시작 값 (기본값: 1)
        increment: 1 # 증가 단위 (기본값: 1)
```

#### 자동 증가 기능 특징

- **시작 값**: `start_value`로 설정 (기본값: 1)
- **증가 단위**: `increment`로 설정 (기본값: 1)
- **자동 생성**: 내보내기 시마다 1부터 시작하여 순차적으로 증가
- **필터링 무관**: 필터링된 데이터에서도 1부터 시작
- **정렬 무관**: 데이터 정렬과 관계없이 순차적으로 할당


## 완전한 설정 예시

### 예시 엑셀 파일 기반 설정

제공된 예시 엑셀 파일의 구조를 기반으로 한 완전한 설정 예제:

```yaml
csv_export:
  default_format: 'csv'
  encoding: 'utf-8'
  filename:
    pattern: 'logbook_export_{date}_{time}'
    date_format: 'YYYY-MM-DD'
    time_format: 'HH-mm-ss'

  templates:
    - name: 'for_record2020'
      description: '2020년 기록용 템플릿 (예시 엑셀 파일과 동일한 구조)'
      column_order:
        - 'serial_number'
        - 'modality'
        - 'specialty'
        - 'age_group'
        - 'sex'
        - 'study_date'
        - 'reading_date'
        - 'exam_name'

      columns:
        # 일련번호 (자동 생성)
        - serial_number:
            name: '일련번호'
            type: 'number'
            width: 80
            description: '순차적으로 증가하는 일련번호'
            value:
              auto_increment:
                start_value: 1
                increment: 1

        # 검사종류 (메타데이터에서 가져오기)
        - modality:
            name: '검사종류'
            type: 'string'
            width: 120
            description: '검사의 종류'
            value:
              from_metadata:
                key: examination_type_name

        # 세부전공 (데이터 필드에서 가져오기)
        - specialty:
            name: '세부전공'
            type: 'string'
            width: 150
            description: '검사 담당 전문의 구분'
            value:
              from_field:
                field: 'assign'

        # 소아/성인 구분 (나이 기반 변환)
        - age_group:
            name: '소아/성인'
            type: 'string'
            width: 100
            description: '소아(17세 미만) 또는 성인 구분'
            value:
              transform:
                source_field: 'age'
                default_value: ''
                operations:
                  - type: case
                    cases:
                      - when:
                          lt: 17
                        value: '소아'
                    default: '성인'

        # 환자성별 (데이터 필드에서 가져오기)
        - sex:
            name: '환자성별'
            type: 'string'
            width: 80
            description: '환자의 성별 (M 또는 F)'
            value:
              from_field:
                field: 'sex'

        # 검사일 (데이터 필드에서 가져오기)
        - study_date:
            name: '검사일(년)'
            type: 'date'
            width: 120
            description: '검사가 수행된 날짜'
            format: 'YYYY-MM-DD'
            value:
              from_field:
                field: 'study_date'

        # 판독일 (데이터 필드에서 가져오기)
        - reading_date:
            name: '판독일(년)'
            type: 'date'
            width: 120
            description: '판독 보고서가 작성된 날짜'
            format: 'YYYY-MM-DD'
            value:
              from_field:
                field: 'reading_date'

        # 검사명 (데이터 필드에서 가져오기)
        - exam_name:
            name: '검사명'
            type: 'string'
            width: 200
            description: '수행된 검사의 상세 이름'
            value:
              from_field:
                field: 'exam_name'
```

### 컬럼 매핑 테이블

| 엑셀 컬럼  | 데이터 소스              | 설명                              |
| ---------- | ------------------------ | --------------------------------- |
| 일련번호   | auto_increment           | 순차 증가 번호 (자동 생성)        |
| 검사종류   | from_metadata            | 메타데이터에서 검사 유형 가져오기 |
| 세부전공   | from_field: assign       | 담당 구분 필드                    |
| 소아/성인  | transform (source_field: age) | 나이 기반 자동 계산               |
| 환자성별   | from_field: sex          | 성별 정보                         |
| 검사일(년) | from_field: study_date   | 검사 수행일                       |
| 판독일(년) | from_field: reading_date | 판독 완료일                       |
| 검사명     | from_field: exam_name    | 검사 상세명                       |

## 고급 설정

### 1. 다양한 값 소스 활용

```yaml
# 고정 값 사용
- status:
    name: '상태'
    type: 'string'
    value:
      static:
        value: '완료'

# 메타데이터에서 가져오기
- category:
    name: '분류'
    type: 'string'
    value:
      from_metadata:
        key: category_name

# 데이터 필드에서 가져오기
- patient_id:
    name: '환자ID'
    type: 'string'
    value:
      from_field:
        field: 'patient_id'
```

### 2. 복잡한 데이터 변환

```yaml
# 검사 유형 코드 생성
- exam_type_code:
    name: '검사유형코드'
    type: 'string'
    value:
      transform:
        source_field: 'exam_name'
        default_value: ''
        operations:
          - type: case
            cases:
              - when:
                  contains: 'CT'
                value: 'CT'
              - when:
                  contains: 'MRI'
                value: 'MRI'
              - when:
                  contains: '초음파'
                value: 'US'
            default: 'OTHER'

# 복합 조건 변환
- priority_level:
    name: '우선순위'
    type: 'string'
    value:
      transform:
        source_field: 'age'
        operations:
          - type: case
            cases:
              - when:
                  lt: 17
                value: 'HIGH'
              - when:
                  gte: 17
                  lte: 64
                value: 'MEDIUM'
            default: 'LOW'
```

### 3. 고급 조건부 로직

```yaml
# 복잡한 조건부 값 선택
- department_display:
    name: '부서표시명'
    type: 'string'
    value:
      conditional:
        conditions:
          - condition:
              field: 'department'
              operator: 'contains'
              value: 'NE'
            value_source:
              static:
                value: '신경과'
          - condition:
              field: 'department'
              operator: 'contains'
              value: 'UR'
            value_source:
              static:
                value: '비뇨의학과'
          - condition:
              field: 'department'
              operator: 'contains'
              value: 'OB'
            value_source:
              static:
                value: '산부인과'
        default:
          from_field:
            field: 'department'

# 중첩된 조건부 로직
- complex_specialty:
    name: '복합전공'
    type: 'string'
    value:
      conditional:
        conditions:
          - condition:
              field: 'specialty_name'
              operator: 'equals'
              value: '소아'
            value_source:
              conditional:
                conditions:
                  - condition:
                      field: 'modality'
                      operator: 'contains'
                      value: 'CT'
                    value_source:
                      static:
                        value: '소아CT'
                  - condition:
                      field: 'modality'
                      operator: 'contains'
                      value: 'MRI'
                    value_source:
                      static:
                        value: '소아MRI'
                default:
                  from_metadata:
                    key: 'remarks_name'
        default:
          from_metadata:
            key: 'specialty_name'
```

### 4. 고급 Fallback 체인

```yaml
# 다단계 fallback 체인
- patient_info:
    name: '환자정보'
    type: 'string'
    value:
      fallback_chain:
        - from_field:
            field: 'patient_name'
        - from_metadata:
            key: 'patient_name'
        - conditional:
            conditions:
              - condition:
                  field: 'sex'
                  operator: 'equals'
                  value: 'M'
                value_source:
                  static:
                    value: '남성환자'
              - condition:
                  field: 'sex'
                  operator: 'equals'
                  value: 'F'
                value_source:
                  static:
                    value: '여성환자'
            default:
              static:
                value: '환자정보없음'
        - static:
            value: '알수없음'
```

## 문제 해결

### 1. 자주 묻는 질문

**Q: 특정 컬럼이 비어있게 나와요.**
A: 해당 필드의 데이터가 없거나 변환 함수에 오류가 있을 수 있습니다. 데이터 확인 및 변환 함수 검토가 필요합니다.

**Q: 한글이 깨져서 나와요.**
A: 파일 인코딩을 UTF-8로 설정하고, CSV 파일을 열 때 인코딩을 확인해주세요.

**Q: 날짜 형식이 맞지 않아요.**
A: 날짜 필드의 format 설정을 확인하고, 입력 데이터의 형식과 일치하는지 확인해주세요.



[규칙파일 작성 가이드](./1._규칙파일_작성_가이드.md)
[분류 규칙 작성 가이드](./2._분류_규칙_작성_가이드.md)
